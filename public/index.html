<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hyundai Bridge</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

    <div id="loader"><div class="spinner"></div><div>Lade...</div></div>

    <div class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('dashboard')">Remote</button>
        <button class="tab-btn" onclick="switchTab('config')">Config</button>
    </div>

    <div id="tab-dashboard" class="tab-content active">
        
        <div class="header">
            <div class="car-title">Remote Control</div>
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-value" id="hvBat">--%</div>
                    <div class="status-label"><i class="fa-solid fa-battery-full"></i> Akku</div>
                </div>
                <div class="status-item">
                    <div class="status-value" id="range">--</div>
                    <div class="status-label"><i class="fa-solid fa-road"></i> km</div>
                </div>
            </div>
        </div>

        <div class="car-wrapper">
            <button type="button" class="quick-btn btn-fan" id="btnFanStatus" onclick="actionClimateToggle()"><i class="fa-solid fa-fan"></i></button>
            <button type="button" class="quick-btn btn-lock" onclick="actionLock()"><i class="fa-solid fa-lock"></i></button>
            <div class="car-container locked">
                <div class="sunroof"><i id="lockIcon" class="center-lock fa-solid fa-lock"></i></div>
                <div class="door door-fl"></div><div class="door door-fr"></div>
                <div class="door door-rl"></div><div class="door door-rr"></div>
                <div class="door trunk"></div><div class="door hood"></div>
                <div class="interior"><div class="seat-fl" id="seatDriver"></div><div class="steering-wheel" id="steering"></div></div>
                <div class="rear-window-heat" id="rearHeat"></div>
            </div>
            <button type="button" class="quick-btn btn-horn" onclick="actionUnlock()"><i class="fa-solid fa-lock-open"></i></button>
        </div>
        
        <div class="info-row" style="flex-wrap: wrap;">
            
            <div id="statLock" class="info-badge">
                <i class="fa-solid fa-lock"></i> --
            </div>

            <div id="stat12v" class="info-badge">
                <i class="fa-solid fa-car-battery"></i> 12V: --
            </div>
            
            <div id="statPlug" class="info-badge">
                <i class="fa-solid fa-plug"></i> --
            </div>
        </div>

        <p style="text-align: center; color: #888; font-size: 14px; margin-bottom: 20px;">
            Stand: <span id="updateTime">--:--</span>
        </p>

        <div class="cards-grid">
            <div class="card" style="grid-column: span 2; height: auto;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px;">
                    <i class="card-icon fa-solid fa-temperature-half"></i><span id="climateVal" class="card-value">AUS</span>
                </div>
                <div class="range-wrap"><div style="display:flex; justify-content:space-between; font-size:12px; color:#888;"><label>Temperatur</label><span id="tempDisplay" style="font-weight:bold;">21Â°C</span></div><input type="range" class="form-range" min="16" max="28" step="0.5" id="tempRange" value="21" oninput="updateDisplays()"></div>
                <div class="range-wrap"><div style="display:flex; justify-content:space-between; font-size:12px; color:#888;"><label>Dauer (Min)</label><span id="durDisplay" style="font-weight:bold;">15m</span></div><input type="range" class="form-range" min="5" max="30" step="5" id="durationRange" value="15" oninput="updateDisplays()"></div>
                <div style="margin-bottom: 15px; font-size: 14px;"><input type="checkbox" id="defrostCheck" style="transform: scale(1.2); margin-right: 8px;"><label for="defrostCheck">Enteisen</label></div>
                <div style="display:flex; gap:12px; margin-top:15px;">
                    <button onclick="actionClimate()" class="quick-btn" style="position:relative; flex:1; height:50px; border-radius:14px; background:var(--accent); color:white; font-size:16px; font-weight:600; box-shadow: 0 4px 10px rgba(0,122,255,0.3);"><i class="fa-solid fa-play" style="margin-right:8px; font-size:14px;"></i> Start</button>
                    <button onclick="actionClimateStop()" class="quick-btn" style="position:relative; flex:1; height:50px; border-radius:14px; background:white; color:var(--danger); border:2px solid var(--danger); font-size:16px; font-weight:600; box-shadow:none;"><i class="fa-solid fa-stop" style="margin-right:8px; font-size:14px;"></i> Stop</button>
                </div>
            </div>
            
            <div class="card" onclick="actionChargeStart()"><i class="card-icon fa-solid fa-bolt" style="color: #34c759;"></i><div class="card-title">Laden</div><div class="card-value" id="chargeStatus">Start</div></div>
            
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;"><i class="card-icon fa-solid fa-rotate"></i><div class="card-title">Status</div></div>
                <div style="margin-top: auto; display: flex; flex-direction: column; gap: 8px;">
                    <button onclick="actionRefresh()" class="quick-btn" style="position:relative; width:100%; height:40px; border-radius:12px; font-size:14px; background:var(--bg-color); border:1px solid #ddd; box-shadow:none;"><i class="fa-solid fa-clock-rotate-left" style="margin-right:8px;"></i> Cache</button>
                    <button onclick="actionForce()" class="quick-btn" style="position:relative; width:100%; height:40px; border-radius:12px; font-size:14px; background:white; color:var(--danger); border:1px solid var(--danger); box-shadow:none;"><i class="fa-solid fa-cloud-arrow-down" style="margin-right:8px;"></i> Live</button>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-config" class="tab-content">
        <div style="max-width: 600px; margin: 0 auto; padding: 10px 10px 80px 10px;">
            
            <div class="card" style="height: auto; cursor: default; margin-bottom: 20px;">
                <div class="card-title">System Status</div>
                <div style="font-family: monospace; font-size: 14px; line-height: 1.8;">
                    <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:5px 0;"><span>IP:</span> <span id="confIp" style="font-weight:bold;">--</span></div>
                    <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:5px 0;"><span>Port:</span> <span id="confPort">--</span></div>
                    <div style="display:flex; justify-content:space-between; padding:5px 0;"><span>Version:</span> <span id="confVer">--</span></div>
                </div>
            </div>

            <div class="card" style="height: auto; cursor: default; margin-bottom: 20px; border: 1px solid #007aff22;">
                <div class="card-title" style="color:var(--accent);">ðŸ”‘ Hyundai Login</div>
                <div class="range-wrap" style="margin-bottom: 10px;"><label style="font-size:12px; font-weight:600; color:#555;">Email</label><input type="text" id="bluelinkUser" class="form-input"></div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <div><label style="font-size:12px; font-weight:600; color:#555;">Passwort</label><input type="password" id="bluelinkPass" class="form-input"></div>
                    <div><label style="font-size:12px; font-weight:600; color:#555;">PIN</label><input type="password" id="bluelinkPin" class="form-input" placeholder="4 stellig"></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div><label style="font-size:12px; font-weight:600; color:#555;">VIN (Optional)</label><input type="text" id="bluelinkVin" class="form-input"></div>
                     <div><label style="font-size:12px; font-weight:600; color:#555;">Marke</label><select id="brand" class="form-input" style="height:42px;"><option value="hyundai">Hyundai</option><option value="kia">Kia</option></select></div>
                </div>
            </div>

            <div class="card" style="height: auto; cursor: default; margin-bottom: 20px;">
                <div class="card-title">Loxone UDP</div>
                <div class="range-wrap" style="margin-bottom: 15px;"><label style="font-size:12px; font-weight:600; color:#555;">Miniserver IP</label><input type="text" id="udpHost" class="form-input" placeholder="192.168.1.x"></div>
                <div class="range-wrap" style="margin-bottom: 15px;"><label style="font-size:12px; font-weight:600; color:#555;">UDP Port</label><input type="number" id="udpPort" class="form-input" placeholder="z.B. 7888"></div>
                <div style="margin: 15px 0; display:flex; align-items:center;"><input type="checkbox" id="enableUdp" style="transform: scale(1.3); margin-right: 10px;"><label for="enableUdp" style="font-size:14px;">Automatisch senden</label></div>
                <button onclick="downloadLoxoneTemplate()" class="quick-btn" style="position:relative; width:100%; height:45px; border-radius:12px; background:#34c759; color:white; font-size:14px; font-weight:600; box-shadow:none;"><i class="fa-solid fa-file-export" style="margin-right:8px;"></i> Loxone Template</button>
            </div>

            <div class="card" style="height: auto; cursor: default; margin-bottom: 25px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div class="card-title">MQTT Integration</div>
                    <div id="mqttStatusDisplay" style="font-size:12px; font-weight:bold; padding:4px 8px; border-radius:8px; background:#eee;">Unbekannt</div>
                </div>
                <div class="range-wrap" style="margin-bottom: 10px;"><label style="font-size:12px; font-weight:600; color:#555;">Broker IP</label><input type="text" id="mqttHost" class="form-input" placeholder="192.168.1.x"></div>
                <div class="range-wrap" style="margin-bottom: 10px;"><label style="font-size:12px; font-weight:600; color:#555;">Port</label><input type="number" id="mqttPort" class="form-input" value="1883"></div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <div><label style="font-size:12px; font-weight:600; color:#555;">User</label><input type="text" id="mqttUser" class="form-input"></div>
                    <div><label style="font-size:12px; font-weight:600; color:#555;">Passwort</label><input type="password" id="mqttPass" class="form-input"></div>
                </div>
                <div class="range-wrap">
                    <label style="font-size:12px; font-weight:600; color:#555;">Base Topic</label>
                    <input type="text" id="mqttTopic" class="form-input" value="hyundai" oninput="updateMqttPreview()">
                </div>
            </div>

            <button onclick="saveConfig()" class="quick-btn" style="position:relative; width:100%; height:55px; border-radius:14px; background:var(--accent); color:white; font-size:18px; font-weight:bold; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,122,255,0.3);"><i class="fa-solid fa-floppy-disk" style="margin-right:8px;"></i> Speichern & Verbinden</button>

            <div class="card" style="height: auto; cursor: default; background: #fff; border: 1px solid #eee; margin-bottom: 40px;">
                <div class="card-title" style="margin-bottom:15px; font-size:16px;">ðŸ“š Schnittstellen Dokumentation</div>

                <h4 style="margin:0 0 10px 0; color:var(--accent); font-size:14px;">ðŸ“¡ UDP Push (Loxone)</h4>
                <p style="font-size:12px; color:#666; margin-bottom:10px;">Der Server sendet Befehle im Format <code>Key: Value</code>.</p>
                <table style="width:100%; font-size:12px; color:#444; border-collapse: collapse; margin-bottom:20px;">
                    <tr style="border-bottom:1px solid #eee;"><td style="padding:4px; font-weight:bold; color:#000;">Hyundai_BatSoc</td><td style="padding:4px;">Batterieladestand in %</td></tr>
                    <tr style="border-bottom:1px solid #eee;"><td style="padding:4px; font-weight:bold; color:#000;">Hyundai_Range</td><td style="padding:4px;">Reichweite in km</td></tr>
                    <tr style="border-bottom:1px solid #eee;"><td style="padding:4px; font-weight:bold; color:#000;">Hyundai_Locked</td><td style="padding:4px;">1 = Verriegelt, 0 = Offen</td></tr>
                    <tr style="border-bottom:1px solid #eee;"><td style="padding:4px; font-weight:bold; color:#000;">Hyundai_Climate</td><td style="padding:4px;">1 = Klima an, 0 = Klima aus</td></tr>
                    <tr><td style="padding:4px; font-weight:bold; color:#000;">Hyundai_Charging</td><td style="padding:4px;">1 = LÃ¤dt, 0 = LÃ¤dt nicht</td></tr>
                </table>

                <h4 style="margin:0 0 10px 0; color:var(--accent); font-size:14px;">ðŸ“¡ MQTT (Alles Lowercase)</h4>
                <p style="font-size:12px; color:#666; margin-bottom:15px;">
                    Alle Topics werden rekursiv und in Kleinbuchstaben ausgegeben.<br>
                    Vorschau fÃ¼r dein Base Topic:
                </p>
                <div id="mqttExamples" style="background:#f4f4f4; padding:8px; border-radius:6px; font-size:11px; font-family:monospace; color:#333; margin-bottom:20px;">
                    hyundai/green/batterymanagement/batteryremain/ratio = 80<br>
                    hyundai/drivetrain/fuelsystem/dte/total = 350<br>
                    hyundai/bridge/status = online
                </div>

                <h4 style="margin:0 0 10px 0; color:var(--accent); font-size:14px;">ðŸ”— REST API Endpunkte</h4>
                <div style="font-size: 12px; color: #444; font-family: monospace; line-height: 1.6;">
                    <div style="margin-bottom:12px; border-left:3px solid #34c759; padding-left:10px;">
                        <strong style="color:#000;">GET /status</strong><br><span style="color:#888;">// Cache (Schnell)</span>
                    </div>
                    <div style="margin-bottom:12px; border-left:3px solid #ff3b30; padding-left:10px;">
                        <strong style="color:#000;">GET /status/refresh</strong><br><span style="color:#888;">// Live (Langsam!)</span>
                    </div>
                    <div style="margin-bottom:12px; border-left:3px solid var(--accent); padding-left:10px;">
                        <strong style="color:#000;">POST /climate/start</strong><br>
                        <span style="color:#888;">// Body: {"temperature": 21, "duration": 15, "defrost": true}</span>
                    </div>
                    <div><strong style="color:#000;">POST /climate/stop</strong> | <strong style="color:#000;">POST /lock</strong></div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="js/client.js"></script>
    <script>
        function updateDisplays() {
            document.getElementById('tempDisplay').innerText = document.getElementById('tempRange').value + 'Â°C';
            document.getElementById('durDisplay').innerText = document.getElementById('durationRange').value + 'm';
        }
    </script>
</body>
</html>